<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anigen (Web Demo)</title>
  <link rel="stylesheet" href="../../dist/output.css" />
  <style>
    .demo-shell {
      min-height: 100vh;
      background: #ffffff;
    }

    .anigen-window {
      width: min(980px, 100%);
      margin: 0 auto;
      padding: 18px;
    }

    .anigen-titlebar {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 46px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 700;
      color: #111827;
      font-size: 20px;
    }

    .anigen-main {
      display: grid;
      grid-template-columns: 1fr 270px;
      gap: 22px;
      padding-top: 16px;
    }

    @media (max-width: 900px) {
      .anigen-main {
        grid-template-columns: 1fr;
      }
    }

    .preview-wrap {
      display: grid;
      place-items: center;
      background: #ffffff;
    }

    .preview-frame {
      width: 520px;
      max-width: 100%;
      aspect-ratio: 1 / 1;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      display: grid;
      place-items: center;
    }

    canvas {
      width: 480px;
      height: 480px;
      max-width: 96%;
      max-height: 96%;
    }

    .control-col {
      background: #ffffff;
      padding-top: 14px;
    }

    .ctrl-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }

    .ctrl-title {
      font-weight: 700;
      color: #111827;
    }

    .ctrl-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btn-arrow {
      width: 52px;
      height: 28px;
      border: 1px solid #94a3b8;
      background: linear-gradient(#f8fafc, #cbd5e1);
      color: #111827;
      font-weight: 700;
      border-radius: 0;
    }

    .ctrl-label {
      font-weight: 600;
      color: #111827;
      min-height: 18px;
    }

    .ctrl-checkbox {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #111827;
      margin: 10px 0 18px;
    }

    .ctrl-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .ctrl-seg {
      display: grid;
      grid-template-columns: 1fr 1fr;
      width: 200px;
      border: 1px solid #94a3b8;
      background: #f8fafc;
    }

    .ctrl-seg input { display: none; }

    .ctrl-seg label {
      padding: 6px 10px;
      text-align: center;
      font-weight: 700;
      color: #111827;
      cursor: pointer;
      user-select: none;
    }

    .ctrl-seg input:checked + label {
      background: linear-gradient(#f8fafc, #cbd5e1);
    }

    .btn-action {
      width: 96px;
      height: 30px;
      border: 1px solid #94a3b8;
      background: linear-gradient(#f8fafc, #cbd5e1);
      color: #111827;
      font-weight: 700;
      border-radius: 0;
    }

    .btn-save {
      width: 140px;
      height: 34px;
      border: 1px solid #94a3b8;
      background: linear-gradient(#f8fafc, #cbd5e1);
      color: #111827;
      font-weight: 700;
      border-radius: 0;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body class="bg-gray-50">
  <main class="demo-shell">
    <div class="anigen-window">
      <div class="anigen-titlebar">Anigen</div>

      <div class="anigen-main">
        <div class="preview-wrap">
          <div class="preview-frame">
            <canvas id="preview" width="520" height="520" aria-label="Character preview"></canvas>
          </div>
        </div>

        <aside class="control-col" aria-label="Controls">
          <div class="ctrl-group">
            <div class="ctrl-title">Gender</div>
            <div class="ctrl-seg" role="radiogroup" aria-label="Gender">
              <input id="genderMale" name="gender" type="radio" value="male" checked />
              <label for="genderMale">Male</label>
              <input id="genderFemale" name="gender" type="radio" value="female" />
              <label for="genderFemale">Female</label>
            </div>
          </div>

          <div class="ctrl-group">
            <div class="ctrl-title">Base</div>
            <div class="ctrl-row">
              <button id="basePrev" type="button" class="btn-arrow" aria-label="Previous base">&lt;</button>
              <button id="baseNext" type="button" class="btn-arrow" aria-label="Next base">&gt;</button>
            </div>
            <div id="baseLabel" class="ctrl-label"></div>
          </div>

          <div class="ctrl-group">
            <div class="ctrl-title">Face</div>
            <div class="ctrl-row">
              <button id="facePrev" type="button" class="btn-arrow" aria-label="Previous face">&lt;</button>
              <button id="faceNext" type="button" class="btn-arrow" aria-label="Next face">&gt;</button>
            </div>
            <div id="faceLabel" class="ctrl-label"></div>
          </div>

          <div class="ctrl-group">
            <div class="ctrl-title">Hair</div>
            <div class="ctrl-row">
              <button id="hairPrev" type="button" class="btn-arrow" aria-label="Previous hair">&lt;</button>
              <button id="hairNext" type="button" class="btn-arrow" aria-label="Next hair">&gt;</button>
            </div>
            <div id="hairLabel" class="ctrl-label"></div>
          </div>

          <label class="ctrl-checkbox">
            <input id="circle" type="checkbox" checked />
            Circle preview
          </label>

          <div class="ctrl-actions">
            <button id="random" type="button" class="btn-action">Random</button>
            <button id="reset" type="button" class="btn-action">Reset</button>
          </div>

          <button id="save" type="button" class="btn-save">Save as PNG</button>
        </aside>
      </div>
    </div>
  </main>

  <script>
    const els = {
      canvas: document.getElementById('preview'),
      genderMale: document.getElementById('genderMale'),
      genderFemale: document.getElementById('genderFemale'),
      basePrev: document.getElementById('basePrev'),
      baseNext: document.getElementById('baseNext'),
      facePrev: document.getElementById('facePrev'),
      faceNext: document.getElementById('faceNext'),
      hairPrev: document.getElementById('hairPrev'),
      hairNext: document.getElementById('hairNext'),
      baseLabel: document.getElementById('baseLabel'),
      faceLabel: document.getElementById('faceLabel'),
      hairLabel: document.getElementById('hairLabel'),
      circle: document.getElementById('circle'),
      random: document.getElementById('random'),
      reset: document.getElementById('reset'),
      save: document.getElementById('save'),
    };

    const ctx = els.canvas.getContext('2d');

    const state = {
      baseIndex: 0,
      faceIndex: 0,
      hairIndex: 0,
      gender: 'male',
      baseSets: {
        male: [],
        female: [],
      },
      bases: [],
      faces: [],
      hairs: [],
    };

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error(`Failed to load ${src}`));
        img.src = src;
      });
    }

    async function loadSequence(prefix, max = 50) {
      const images = [];
      for (let i = 1; i <= max; i += 1) {
        const src = `assets/${prefix}${i}.png`;
        try {
          const img = await loadImage(src);
          images.push(img);
        } catch (_) {
          break;
        }
      }
      return images;
    }

    function clampIndex(idx, len) {
      if (len <= 0) return 0;
      return ((idx % len) + len) % len;
    }

    function updateLabels() {
      els.baseLabel.textContent = state.bases.length ? `Base ${state.baseIndex + 1} / ${state.bases.length}` : 'Base -';
      els.faceLabel.textContent = state.faces.length ? `Face ${state.faceIndex + 1} / ${state.faces.length}` : 'Face -';
      els.hairLabel.textContent = state.hairs.length ? `Hair ${state.hairIndex + 1} / ${state.hairs.length}` : 'Hair -';
    }

    function syncControlAvailability() {
      const layered = state.gender === 'male';
      els.facePrev.disabled = !layered;
      els.faceNext.disabled = !layered;
      els.hairPrev.disabled = !layered;
      els.hairNext.disabled = !layered;
      const opacity = layered ? '1' : '0.45';
      els.facePrev.style.opacity = opacity;
      els.faceNext.style.opacity = opacity;
      els.hairPrev.style.opacity = opacity;
      els.hairNext.style.opacity = opacity;
      if (!layered) {
        els.faceLabel.textContent = 'Face -';
        els.hairLabel.textContent = 'Hair -';
      }
    }

    function drawToContext(targetCtx, w, h, circleClip) {
      targetCtx.clearRect(0, 0, w, h);

      const base = state.bases[state.baseIndex] || null;
      const layered = state.gender === 'male';
      const face = layered ? (state.faces[state.faceIndex] || null) : null;
      const hair = layered ? (state.hairs[state.hairIndex] || null) : null;

      const reference = base || face || hair;
      if (!reference) return;

      const refW = reference.naturalWidth || reference.width;
      const refH = reference.naturalHeight || reference.height;

      const scale = Math.min(w / refW, h / refH);
      const drawW = Math.round(refW * scale);
      const drawH = Math.round(refH * scale);
      const x = Math.round((w - drawW) / 2);
      const y = Math.round((h - drawH) / 2);

      if (circleClip) {
        const diameter = Math.min(w, h);
        const clipX = Math.round((w - diameter) / 2);
        const clipY = Math.round((h - diameter) / 2);
        targetCtx.save();
        targetCtx.beginPath();
        targetCtx.ellipse(clipX + diameter / 2, clipY + diameter / 2, diameter / 2, diameter / 2, 0, 0, Math.PI * 2);
        targetCtx.clip();
      }

      if (base) targetCtx.drawImage(base, x, y, drawW, drawH);
      if (face) targetCtx.drawImage(face, x, y, drawW, drawH);
      if (hair) targetCtx.drawImage(hair, x, y, drawW, drawH);

      if (circleClip) {
        targetCtx.restore();
      }
    }

    function render() {
      state.bases = state.baseSets[state.gender] || [];
      state.baseIndex = clampIndex(state.baseIndex, state.bases.length);
      state.faceIndex = clampIndex(state.faceIndex, state.faces.length);
      state.hairIndex = clampIndex(state.hairIndex, state.hairs.length);
      updateLabels();
      syncControlAvailability();
      drawToContext(ctx, els.canvas.width, els.canvas.height, els.circle.checked);
    }

    function setGender(next) {
      if (next !== 'male' && next !== 'female') return;
      if (state.gender === next) return;
      state.gender = next;
      state.baseIndex = 0;
      render();
    }

    function randomize() {
      if (state.bases.length) state.baseIndex = Math.floor(Math.random() * state.bases.length);
      if (state.faces.length) state.faceIndex = Math.floor(Math.random() * state.faces.length);
      if (state.hairs.length) state.hairIndex = Math.floor(Math.random() * state.hairs.length);
      render();
    }

    function reset() {
      state.baseIndex = 0;
      state.faceIndex = 0;
      state.hairIndex = 0;
      els.circle.checked = true;
      render();
    }

    function savePng() {
      const circleClip = els.circle.checked;

      if (!circleClip) {
        const url = els.canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = url;
        a.download = 'anigen.png';
        a.click();
        return;
      }

      const diameter = Math.min(els.canvas.width, els.canvas.height);
      const out = document.createElement('canvas');
      out.width = diameter;
      out.height = diameter;
      const outCtx = out.getContext('2d');
      outCtx.save();
      outCtx.beginPath();
      outCtx.ellipse(diameter / 2, diameter / 2, diameter / 2, diameter / 2, 0, 0, Math.PI * 2);
      outCtx.clip();
      drawToContext(outCtx, diameter, diameter, false);
      outCtx.restore();

      const url = out.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      a.download = 'anigen.png';
      a.click();
    }

    els.basePrev.addEventListener('click', () => {
      state.baseIndex -= 1;
      render();
    });
    els.baseNext.addEventListener('click', () => {
      state.baseIndex += 1;
      render();
    });
    els.facePrev.addEventListener('click', () => {
      state.faceIndex -= 1;
      render();
    });
    els.faceNext.addEventListener('click', () => {
      state.faceIndex += 1;
      render();
    });
    els.hairPrev.addEventListener('click', () => {
      state.hairIndex -= 1;
      render();
    });
    els.hairNext.addEventListener('click', () => {
      state.hairIndex += 1;
      render();
    });
    els.genderMale.addEventListener('change', () => setGender('male'));
    els.genderFemale.addEventListener('change', () => setGender('female'));
    els.circle.addEventListener('change', render);
    els.random.addEventListener('click', randomize);
    els.reset.addEventListener('click', reset);
    els.save.addEventListener('click', savePng);

    (async function init() {
      state.baseSets.male = await loadSequence('p');
      state.baseSets.female = await loadSequence('girl');
      state.faces = await loadSequence('face');
      state.hairs = await loadSequence('hair');
      state.gender = els.genderFemale && els.genderFemale.checked ? 'female' : 'male';
      render();
    })();
  </script>
</body>
</html>
